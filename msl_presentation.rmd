---
title: 'Machine Learning - presentation '
author: "Monika Kaczan and Katarzyna Ja≈Çbrzykowska"
date: "05 June 2022"
output:
  html_document:
    toc: yes
    toc_float:
      toc_collapsed: yes
    toc_depth: 3
    number_sections: no
  pdf_document:
    toc: yes
    toc_depth: '3'
---



```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

<style>
body {
text-align: justify}
</style>

```{r include=FALSE}
# Libraries
library(dplyr)
library(readr)
library(ggplot2)
library(caret)
library(tibble)
library(purrr)
library(corrplot)
library(DescTools)
library(glmnet)
library(AER)
library(lmtest)
library(nnet)
library(pROC)
library(ROSE)
library(janitor)
library(DMwR)
library(bestNormalize)
library(Information)
library(smbinning)
library(lattice)
library(woeBinning)
library(lubridate)
library(xts)
library(dygraphs)
library(car)
library(magrittr)
library(olsrr)
library(stats)
library(forecast)
library(forcats)
library(tidyr)
library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
```

# Classification - drugs dataset

### Data preparation

Firstly, we loaded the data, checked how they look like and whether there are any missing observations. We dropped the id column.

```{r include=FALSE}
drugs <- read_csv("drugs_train.csv")
drugs_to_test <- read_csv("drugs_test.csv")
any(is.na(drugs))
drugs <- subset(drugs, select = -c(id) )
glimpse(drugs)
```

```{r echo=TRUE}
glimpse(drugs)
```

As ordinal and categorical variables are stored as characters, we converted them into factors. We also noticed that some categories are similar in terms of definition, or contain very few observations. This is why we decided to:
- merge Canada, Ireland, UK and New Zealand to 'Other' in variable 'country'
- merge 55-64 and 65+ categories for 'age'
- merge all 'Left school before...' categories for 'education' as well as merge 'Masters degree' and 'Doctorate degree'
- merge 'never used' and 'used over a decade ago' as well as 'used in last day' and 'used in last week' categories for all consumption variables.
We also decided to drop variable 'ethnicity' because it was almost homogeneous. 

```{r include=FALSE}
drugs$gender = factor(drugs$gender, levels = c("male", "female"), ordered = TRUE)
drugs$consumption_cocaine_last_month = factor(drugs$consumption_cocaine_last_month, levels = c("No", "Yes"), ordered = TRUE)
glimpse(drugs)

# Most people are either from Australia or USA. Other countries (Canada, Ireland, UK and New Zeland) all have under 10% of representation. Therefore we decided to include them as "Other".  
table(drugs$country)
drugs$country[drugs$country %in% c("Canada","Ireland", "UK", "New Zealand")] <- "Other"
drugs$country <- as.factor(drugs$country)
```

```{r echo=TRUE}
table(drugs$ethnicity)
drugs <- subset(drugs, select = -c(ethnicity) )
```

```{r include=FALSE}
table(drugs$age)
drugs$age[drugs$age == "65+"] <- "55-64"
drugs$age[drugs$age == "55-64"] <- "55+"
drugs$age <- factor(drugs$age, 
                    levels = c("18-24", "25-34", "35-44", "45-54", "55+"),
                    ordered = TRUE)
drugs$age <- droplevels(drugs$age)

table(drugs$education)
drugs$education[drugs$education == "Left school before 16 years"] <- "Left school at/before 18 years"
drugs$education[drugs$education == "Left school at 16 years"] <- "Left school at/before 18 years"
drugs$education[drugs$education == "Left school at 17 years"] <- "Left school at/before 18 years"
drugs$education[drugs$education == "Left school at 18 years"] <- "Left school at/before 18 years"
drugs$education[drugs$education == "Masters degree"] <- "Masters degree or higher"
drugs$education[drugs$education == "Doctorate degree"] <- "Masters degree or higher"
table(drugs$education)
drugs$education <- factor(drugs$education,
                          levels = c("Left school at/before 18 years",
                                     "Some college or university, no certificate or degree",
                                     "Professional certificate/ diploma",
                                     "University degree",
                                     "Masters degree or higher"),
                          ordered = TRUE)
drugs$education <- droplevels(drugs$education)

table(drugs$consumption_alcohol) # Here we changed variables names
drugs$consumption_alcohol <- factor(drugs$consumption_alcohol,
                                    levels = c("never used",
                                               "used over a decade ago",
                                               "used in last decade",
                                               "used in last year",
                                               "used in last month",
                                               "used in last week", 
                                               "used in last day"),
                                    ordered = TRUE)
drugs$consumption_amphetamines <- factor(drugs$consumption_amphetamines,
                                         levels = c("never used",
                                                    "used over a decade ago",
                                                    "used in last decade",
                                                    "used in last year",
                                                    "used in last month",
                                                    "used in last week", 
                                                    "used in last day"),
                                         ordered = TRUE)
drugs$consumption_caffeine <- factor(drugs$consumption_caffeine,
                                     levels = c("never used",
                                                "used over a decade ago",
                                                "used in last decade",
                                                "used in last year",
                                                "used in last month",
                                                "used in last week", 
                                                "used in last day"),
                                     ordered = TRUE)
drugs$consumption_cannabis <- factor(drugs$consumption_cannabis,
                                     levels = c("never used",
                                                "used over a decade ago",
                                                "used in last decade",
                                                "used in last year",
                                                "used in last month",
                                                "used in last week", 
                                                "used in last day"),
                                     ordered = TRUE)
drugs$consumption_chocolate <- factor(drugs$consumption_chocolate,
                                      levels = c("never used",
                                                 "used over a decade ago",
                                                 "used in last decade",
                                                 "used in last year",
                                                 "used in last month",
                                                 "used in last week", 
                                                 "used in last day"),
                                      ordered = TRUE)
drugs$consumption_mushrooms <- factor(drugs$consumption_mushrooms,
                                      levels = c("never used",
                                                 "used over a decade ago",
                                                 "used in last decade",
                                                 "used in last year",
                                                 "used in last month",
                                                 "used in last week", 
                                                 "used in last day"),
                                      ordered = TRUE)
drugs$consumption_nicotine <- factor(drugs$consumption_nicotine,
                                     levels = c("never used",
                                                "used over a decade ago",
                                                "used in last decade",
                                                "used in last year",
                                                "used in last month",
                                                "used in last week", 
                                                "used in last day"),
                                     ordered = TRUE)

drugs$consumption_alcohol[drugs$consumption_alcohol == "never used"] <- "used over a decade ago"
drugs$consumption_alcohol[drugs$consumption_alcohol == "used in last day"] <- "used in last week"
drugs$consumption_alcohol <- droplevels(drugs$consumption_alcohol)

drugs$consumption_amphetamines[drugs$consumption_amphetamines == "never used"] <- "used over a decade ago"
drugs$consumption_amphetamines[drugs$consumption_amphetamines == "used in last day"] <- "used in last week"
drugs$consumption_amphetamines <- droplevels(drugs$consumption_amphetamines)

drugs$consumption_caffeine[drugs$consumption_caffeine == "never used"] <- "used over a decade ago"
drugs$consumption_caffeine[drugs$consumption_caffeine == "used in last day"] <- "used in last week"
drugs$consumption_caffeine <- droplevels(drugs$consumption_caffeine)

drugs$consumption_cannabis[drugs$consumption_cannabis == "never used"] <- "used over a decade ago"
drugs$consumption_cannabis[drugs$consumption_cannabis == "used in last day"] <- "used in last week"
drugs$consumption_cannabis <- droplevels(drugs$consumption_cannabis)

drugs$consumption_chocolate[drugs$consumption_chocolate == "never used"] <- "used over a decade ago"
drugs$consumption_chocolate[drugs$consumption_chocolate == "used in last day"] <- "used in last week"
drugs$consumption_chocolate <- droplevels(drugs$consumption_chocolate)

drugs$consumption_mushrooms[drugs$consumption_mushrooms == "never used"] <- "used over a decade ago"
drugs$consumption_mushrooms[drugs$consumption_mushrooms == "used in last day"] <- "used in last week"
drugs$consumption_mushrooms <- droplevels(drugs$consumption_mushrooms)

drugs$consumption_nicotine[drugs$consumption_nicotine == "never used"] <- "used over a decade ago"
drugs$consumption_nicotine[drugs$consumption_nicotine == "used in last day"] <- "used in last week"
drugs$consumption_nicotine <- droplevels(drugs$consumption_nicotine)
```

We also checked relationship between the dependend variable (consumption_cocaine_last_month) and different consumptions of drugs and other products using Cramer V. Based on that, very low Information Value (< 0.01), and 'real-life justification' we decided to drop it from the model.

```{r echo=TRUE}
DescTools::CramerV(drugs$consumption_cocaine_last_month,
                   drugs$consumption_caffeine)
drugs <- subset(drugs, select = -c(consumption_caffeine))
```

To reduce possible overfitting of the model, we decided to transform numerical variables related to personality based on cut-off points: under 35 point would indicate that this personality trait is weak, between 35 and 65 points that character trait is neutral, and above 65 that it is strong.

```{r include=FALSE}
drugs$personality_neuroticism <- ifelse(drugs$personality_neuroticism < 35, 0, ifelse(drugs$personality_neuroticism < 65, 1, 2))
drugs$personality_openness <- ifelse(drugs$personality_openness < 35, 0, ifelse(drugs$personality_openness < 65, 1, 2))
drugs$personality_agreeableness <- ifelse(drugs$personality_agreeableness < 35, 0, ifelse(drugs$personality_agreeableness < 65, 1, 2))
drugs$personality_extraversion <- ifelse(drugs$personality_extraversion < 35, 0, ifelse(drugs$personality_extraversion < 65, 1, 2))
drugs$personality_conscientiousness <- ifelse(drugs$personality_conscientiousness < 35, 0, ifelse(drugs$personality_conscientiousness < 65, 1, 2))
drugs$personality_impulsiveness <- ifelse(drugs$personality_impulsiveness < 35, 0, ifelse(drugs$personality_impulsiveness < 65, 1, 2))
drugs$personality_sensation <- ifelse(drugs$personality_sensation < 35, 0, ifelse(drugs$personality_sensation < 65, 1, 2))
drugs[, 5:11] <- lapply(drugs[, 5:11], factor)
glimpse(drugs)
```



### Balancing sample

Our sample turned out to be unbalanced, therefore we decided to balance it using upsampling which turned out to provide the best results in terms of ROC and Accuracy. 

```{r echo=TRUE}
table(drugs$consumption_cocaine_last_month)
```

```{r include=FALSE}

fiveStats <- function(...) c(twoClassSummary(...), 
                             defaultSummary(...))
source("functions/F_own_summary_functions.R")


# For model validation we are splitting the data into train and test samples. Additionaly, we are using cross-validation on the training sample. Here in each case we are using 5-fold cross-validation repeated 3 times.

set.seed(987654321)
drugs_which_training <- createDataPartition(drugs$consumption_cocaine_last_month,
                                            p = 1099/1500, 
                                            list = FALSE) 

drugs_train <- drugs[c(drugs_which_training),]
drugs_test <- drugs[-c(drugs_which_training),]

ctrl_cv5 <- trainControl(method = "repeatedcv",
                         number = 5,
                         classProbs = TRUE,
                         summaryFunction = mySummary,
                         repeats = 3)
```

```{r echo=TRUE}
ctrl_cv5$sampling <- "up"
set.seed(987654321)
drugs_logit_train_up <- 
  train(consumption_cocaine_last_month ~ ., 
        data = drugs_train,
        method = "glm",
        family = "binomial",
        trControl = ctrl_cv5
  )
drugs_logit_train_up
```



### KNN

KNN (k nearest neighbours) is a supervised learning method in which (in case of classification) the object is being assigned to the class most common among its k nearest neighbors. We have chosen KNN because it has provided the best results on test sample compared to other models (probit, logit and SVM) in terms of Balanced Accuracy. However, Logit model was also considered. 

We tried different values of k for KNN from 1 to 40 by 2 and selected the best one which is 35. 

```{r echo=TRUE}
ctrl_cv5_knn <- trainControl(method = "repeatedcv",
                             number = 5,
                             classProbs = TRUE,
                             summaryFunction = mySummary,
                             repeats = 3)
ctrl_cv5_knn$sampling <- "up"

different_k = data.frame(k = seq(1, 40, 2) )

set.seed(987654321)
drugs_knn_train <- 
  train(consumption_cocaine_last_month ~ .,
        drugs_train,        
        method = "knn",
        metric = "ROC",
        trControl = ctrl_cv5_knn,
        tuneGrid = different_k,
        preProcess = c("range"))

drugs_knn_train
plot(drugs_knn_train)

k_value <- data.frame(k = 35)

set.seed(987654321)
drugs_knn_train_final <- 
  train(consumption_cocaine_last_month ~ .,
        drugs_train,        
        method = "knn",
        metric = "ROC",
        trControl = ctrl_cv5_knn,
        tuneGrid = k_value,
        preProcess = c("range"))

drugs_knn_train_final
```

The final model specifications are as follows:

```{r echo=FALSE}
source("functions/F_summary_binary_class.R")
knn_fitted = predict(drugs_knn_train_final, drugs_train)
knn_results = summary_binary_class(predicted_classes = knn_fitted,
                                   real = drugs_train$consumption_cocaine_last_month)
knn_fitted_test = predict(drugs_knn_train_final, drugs_test)
knn_results_test = summary_binary_class(predicted_classes = knn_fitted_test,
                                        real = drugs_test$consumption_cocaine_last_month)
knn_fitted_all = predict(drugs_knn_train_final, drugs)
knn_results_all = summary_binary_class(predicted_classes = knn_fitted_all,
                                       real = drugs$consumption_cocaine_last_month)

comparison <- matrix(3:1, nrow = 3, ncol = 7)
rownames(comparison) <- c("Training data", "Test data", "All data (test + training combined)") 
colnames(comparison) <- c("Accuracy", "Sensitivity", "Specificity", "Pos Pred Value", "Neg Pred Value", "F1", "Balanced accuracy")
comparison[1, ] <- knn_results
comparison[2, ] <- knn_results_test
comparison[3, ] <- knn_results_all
comparison
```

We applied the final model on the test sample prepared by the teacher. Our expected results would be similar to the test subsample of the training sample that we analyzed above i.e. Balanced Accuracy of around 0.76.

```{r include=FALSE}
drugs_to_test <- read_csv("drugs_test.csv")
any(is.na(drugs_to_test))
glimpse(drugs_to_test)
drugs_to_test <- subset(drugs_to_test, select = -c(id) )

drugs_to_test$gender = factor(drugs_to_test$gender, levels = c("male", "female"), ordered = TRUE)

drugs_to_test$country[drugs_to_test$country %in% c("Canada","Ireland", "UK", "New Zealand")] <- "Other"
drugs_to_test$country <- as.factor(drugs_to_test$country)

drugs_to_test <- subset(drugs_to_test, select = -c(ethnicity) )

table(drugs_to_test$age)
drugs_to_test$age[drugs_to_test$age == "65+"] <- "55-64"
drugs_to_test$age[drugs_to_test$age == "55-64"] <- "55+"
drugs_to_test$age <- factor(drugs_to_test$age, 
                    levels = c("18-24", "25-34", "35-44", "45-54", "55+"),
                    ordered = TRUE)
drugs_to_test$age <- droplevels(drugs_to_test$age)

drugs_to_test$education[drugs_to_test$education == "Left school before 16 years"] <- "Left school at/before 18 years"
drugs_to_test$education[drugs_to_test$education == "Left school at 16 years"] <- "Left school at/before 18 years"
drugs_to_test$education[drugs_to_test$education == "Left school at 17 years"] <- "Left school at/before 18 years"
drugs_to_test$education[drugs_to_test$education == "Left school at 18 years"] <- "Left school at/before 18 years"
drugs_to_test$education[drugs_to_test$education == "Masters degree"] <- "Masters degree or higher"
drugs_to_test$education[drugs_to_test$education == "Doctorate degree"] <- "Masters degree or higher"
drugs_to_test$education <- factor(drugs_to_test$education,
                          levels = c("Left school at/before 18 years",
                                     "Some college or university, no certificate or degree",
                                     "Professional certificate/ diploma",
                                     "University degree",
                                     "Masters degree or higher"),
                          ordered = TRUE)
drugs_to_test$education <- droplevels(drugs_to_test$education)
drugs_to_test$consumption_alcohol <- factor(drugs_to_test$consumption_alcohol,
                                    levels = c("never used",
                                               "used over a decade ago",
                                               "used in last decade",
                                               "used in last year",
                                               "used in last month",
                                               "used in last week", 
                                               "used in last day"),
                                    ordered = TRUE)
drugs_to_test$consumption_amphetamines <- factor(drugs_to_test$consumption_amphetamines,
                                         levels = c("never used",
                                                    "used over a decade ago",
                                                    "used in last decade",
                                                    "used in last year",
                                                    "used in last month",
                                                    "used in last week", 
                                                    "used in last day"),
                                         ordered = TRUE)
drugs_to_test$consumption_caffeine <- factor(drugs_to_test$consumption_caffeine,
                                     levels = c("never used",
                                                "used over a decade ago",
                                                "used in last decade",
                                                "used in last year",
                                                "used in last month",
                                                "used in last week", 
                                                "used in last day"),
                                     ordered = TRUE)
drugs_to_test$consumption_cannabis <- factor(drugs_to_test$consumption_cannabis,
                                     levels = c("never used",
                                                "used over a decade ago",
                                                "used in last decade",
                                                "used in last year",
                                                "used in last month",
                                                "used in last week", 
                                                "used in last day"),
                                     ordered = TRUE)
drugs_to_test$consumption_chocolate <- factor(drugs_to_test$consumption_chocolate,
                                      levels = c("never used",
                                                 "used over a decade ago",
                                                 "used in last decade",
                                                 "used in last year",
                                                 "used in last month",
                                                 "used in last week", 
                                                 "used in last day"),
                                      ordered = TRUE)
drugs_to_test$consumption_mushrooms <- factor(drugs_to_test$consumption_mushrooms,
                                      levels = c("never used",
                                                 "used over a decade ago",
                                                 "used in last decade",
                                                 "used in last year",
                                                 "used in last month",
                                                 "used in last week", 
                                                 "used in last day"),
                                      ordered = TRUE)
drugs_to_test$consumption_nicotine <- factor(drugs_to_test$consumption_nicotine,
                                     levels = c("never used",
                                                "used over a decade ago",
                                                "used in last decade",
                                                "used in last year",
                                                "used in last month",
                                                "used in last week", 
                                                "used in last day"),
                                     ordered = TRUE)

drugs_to_test$consumption_alcohol[drugs_to_test$consumption_alcohol == "never used"] <- "used over a decade ago"
drugs_to_test$consumption_alcohol[drugs_to_test$consumption_alcohol == "used in last day"] <- "used in last week"
drugs_to_test$consumption_alcohol <- droplevels(drugs_to_test$consumption_alcohol)

drugs_to_test$consumption_amphetamines[drugs_to_test$consumption_amphetamines == "never used"] <- "used over a decade ago"
drugs_to_test$consumption_amphetamines[drugs_to_test$consumption_amphetamines == "used in last day"] <- "used in last week"
drugs_to_test$consumption_amphetamines <- droplevels(drugs_to_test$consumption_amphetamines)

drugs_to_test$consumption_caffeine[drugs_to_test$consumption_caffeine == "never used"] <- "used over a decade ago"
drugs_to_test$consumption_caffeine[drugs_to_test$consumption_caffeine == "used in last day"] <- "used in last week"
drugs_to_test$consumption_caffeine <- droplevels(drugs_to_test$consumption_caffeine)

drugs_to_test$consumption_cannabis[drugs_to_test$consumption_cannabis == "never used"] <- "used over a decade ago"
drugs_to_test$consumption_cannabis[drugs_to_test$consumption_cannabis == "used in last day"] <- "used in last week"
drugs_to_test$consumption_cannabis <- droplevels(drugs_to_test$consumption_cannabis)

drugs_to_test$consumption_chocolate[drugs_to_test$consumption_chocolate == "never used"] <- "used over a decade ago"
drugs_to_test$consumption_chocolate[drugs_to_test$consumption_chocolate == "used in last day"] <- "used in last week"
drugs_to_test$consumption_chocolate <- droplevels(drugs_to_test$consumption_chocolate)

drugs_to_test$consumption_mushrooms[drugs_to_test$consumption_mushrooms == "never used"] <- "used over a decade ago"
drugs_to_test$consumption_mushrooms[drugs_to_test$consumption_mushrooms == "used in last day"] <- "used in last week"
drugs_to_test$consumption_mushrooms <- droplevels(drugs_to_test$consumption_mushrooms)

drugs_to_test$consumption_nicotine[drugs_to_test$consumption_nicotine == "never used"] <- "used over a decade ago"
drugs_to_test$consumption_nicotine[drugs_to_test$consumption_nicotine == "used in last day"] <- "used in last week"
drugs_to_test$consumption_nicotine <- droplevels(drugs_to_test$consumption_nicotine)

drugs_to_test <- subset(drugs_to_test, select = -c(consumption_caffeine))

drugs_to_test$personality_neuroticism <- ifelse(drugs_to_test$personality_neuroticism < 35, 0, ifelse(drugs_to_test$personality_neuroticism < 65, 1, 2))
drugs_to_test$personality_openness <- ifelse(drugs_to_test$personality_openness < 35, 0, ifelse(drugs_to_test$personality_openness < 65, 1, 2))
drugs_to_test$personality_agreeableness <- ifelse(drugs_to_test$personality_agreeableness < 35, 0, ifelse(drugs_to_test$personality_agreeableness < 65, 1, 2))
drugs_to_test$personality_extraversion <- ifelse(drugs_to_test$personality_extraversion < 35, 0, ifelse(drugs_to_test$personality_extraversion < 65, 1, 2))
drugs_to_test$personality_conscientiousness <- ifelse(drugs_to_test$personality_conscientiousness < 35, 0, ifelse(drugs_to_test$personality_conscientiousness < 65, 1, 2))
drugs_to_test$personality_impulsiveness <- ifelse(drugs_to_test$personality_impulsiveness < 35, 0, ifelse(drugs_to_test$personality_impulsiveness < 65, 1, 2))
drugs_to_test$personality_sensation <- ifelse(drugs_to_test$personality_sensation < 35, 0, ifelse(drugs_to_test$personality_sensation < 65, 1, 2))
drugs_to_test[, 5:11] <- lapply(drugs_to_test[, 5:11], factor)
glimpse(drugs_to_test)

knn_prediction_on_test_data = predict(drugs_knn_train_final, drugs_to_test)
write.csv(knn_prediction_on_test_data,"knn_test_predictions.csv", row.names = FALSE)
```



# Regression - traffic dataset

## Data preparation

In the first step, we loaded the data. Then they were checked if any missing observations are present within the data. We also analyzed the structure and type of the variables.

```{r message=FALSE, warning=FALSE}
traffic_train=read.csv(file="traffic_train.csv",sep=",",header=TRUE)
traffic_test=read.csv(file="traffic_test.csv",sep=",",header=TRUE)

```


The first column - the date of observation with an accuracy of an hour was converted to the datetime data type.

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train$DateT <- as.POSIXct(traffic_train$date_time, format = "%Y-%m-%d %H:%M:%S", tz="GMT")
traffic_test$DateT <- as.POSIXct(traffic_test$date_time, format = "%Y-%m-%d %H:%M:%S", tz="GMT")
```

Instead of using the index column, we created features describing each time characteristic: hour, month, year, yearweek (which might represent information about holidays), weekday, weekend and date.

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train$time <- format(traffic_train$DateT, format = "%H")
traffic_train$month <- format(traffic_train$DateT, format = "%m")
traffic_train$year <- format(traffic_train$DateT, format = "%Y")
traffic_train$yearweek <- format(traffic_train$DateT, format = "%W")
traffic_train$weekday <- format(traffic_train$DateT, format = "%w")
traffic_train$weekend <- ifelse((traffic_train$weekday == 0)+(traffic_train$weekday == 6),"weekend","weekday")
traffic_train$date <- format(traffic_train$DateT, format = "%Y-%m-%d")

traffic_test$time <- format(traffic_test$DateT, format = "%H")
traffic_test$month <- format(traffic_test$DateT, format = "%m")
traffic_test$year <- format(traffic_test$DateT, format = "%Y")
traffic_test$yearweek <- format(traffic_test$DateT, format = "%W")
traffic_test$weekday <- format(traffic_test$DateT, format = "%w")
traffic_test$weekend <- ifelse((traffic_test$weekday == 0)+(traffic_test$weekday == 6),"weekend","weekday")
traffic_test$date <- format(traffic_test$DateT, format = "%Y-%m-%d")
```

Our train dataset covers the period between 2014-10-01 and 2018-12-31, consists of 1223 days, giving 29701 observations total.

```{r message=FALSE, warning=FALSE, echo=FALSE, results="hide"}
length(unique(traffic_train$date))
c(min(traffic_train$date),max(traffic_train$date))
nrow(traffic_train)
```

The weather conditions are described by two variables: weather_general and weather_detailed. The detailed feature includes 37 levels which are very similar to the general variable levels. In addition, some of the levels are very small, which could affect the results' bias. For this reason, we have decided not to use the weather_detailed characteristic, which should also reduce possible overfitting of the model.

```{r message=FALSE, warning=FALSE}
table(traffic_train$weather_detailed)
```


All variables which were stored as characters were converted to factors.

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train$weather_general <- as.factor(traffic_train$weather_general)
traffic_test$weather_general <- as.factor(traffic_test$weather_general)

traffic_train$weekend <- as.factor(traffic_train$weekend)
traffic_train$yearweek <- as.factor(traffic_train$yearweek)
traffic_train$weekday <- as.factor(traffic_train$weekday)
traffic_train$month <- as.factor(traffic_train$month)
traffic_train$time <- as.factor(traffic_train$time)

traffic_test$weekend <- as.factor(traffic_test$weekend)
traffic_test$yearweek <- as.factor(traffic_test$yearweek)
traffic_test$weekday <- as.factor(traffic_test$weekday)
traffic_test$month <- as.factor(traffic_test$month)
traffic_test$time <- as.factor(traffic_test$time)
```

We also changed the type of the variable Year to numeric.

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train$year <- as.numeric(traffic_train$year)
traffic_test$year <- as.numeric(traffic_test$year)
```

For model validation and testing we split the data into train and test samples: 20368 observations for training and 9322 for test (68:32 ratio), this division is also time based, the test sample starts from the beginning of the year 2018.

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train_train <- traffic_train[traffic_train$year <= 2017,]
traffic_train_test <- traffic_train[traffic_train$year >= 2018,]
```


Most of the observations represented a good weather. However, we merged similar events: levels "Smoke" and "Haze" and "Squall" and "Thunderstorm", which are usually very extreme weather events.

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train_train$weather_general2 <- traffic_train_train$weather_general
traffic_train_train$weather_general2[traffic_train_train$weather_general2 == "Smoke"] <- "Haze"
traffic_train_train$weather_general2[traffic_train_train$weather_general2 == "Squall"] <- "Thunderstorm"
traffic_train_train$weather_general2 <- droplevels(traffic_train_train$weather_general2)

traffic_train_test$weather_general2 <- traffic_train_test$weather_general
traffic_train_test$weather_general2[traffic_train_test$weather_general2 == "Smoke"] <- "Haze"
traffic_train_test$weather_general2[traffic_train_test$weather_general2 == "Squall"] <- "Thunderstorm"
traffic_train_test$weather_general2 <- droplevels(traffic_train_test$weather_general2)

traffic_test$weather_general2 <- traffic_test$weather_general
traffic_test$weather_general2[traffic_test$weather_general2 == "Smoke"] <- "Haze"
traffic_test$weather_general2[traffic_test$weather_general2 == "Squall"] <- "Thunderstorm"
traffic_test$weather_general2 <- droplevels(traffic_test$weather_general2)
```

After checking the structure of the yearweek feature, we noticed that only a few observations were recorded in the last week of the year (no. 53), we combined this level with the no. 52.

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train_train$yearweek[traffic_train_train$yearweek == "53"] <- "52"
traffic_train_train$yearweek <- droplevels(traffic_train_train$yearweek)

traffic_train_test$yearweek[traffic_train_test$yearweek == "53"] <- "52"
traffic_train_test$yearweek <- droplevels(traffic_train_test$yearweek)

traffic_test$yearweek[traffic_test$yearweek == "53"] <- "52"
traffic_test$yearweek <- droplevels(traffic_test$yearweek)
```


We found one outlier in our traffic dataset - with the temperature below -200C. We decided to remove this observation, as it was most likely an error.

```{r message=FALSE, warning=FALSE}
out_temp <- which(traffic_train_train$temperature > -200)
traffic_train_train <- traffic_train_train[out_temp,]
```

## Feature engeneering

#### Box-Cox transformation

To transform our positively skewed dependent variable to a relatively symmetrical distribution, we used a  Box-Cox transformation. 

```{r message=FALSE, warning=FALSE}
traffic_boxcox <- boxcox(traffic_train_train$traffic +1, standardize = FALSE)
```

Our optimal lambda:

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_boxcox$lambda
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train_train$traffic_boxcox <- traffic_boxcox$x.t
traffic_train_test$traffic_boxcox <- predict(traffic_boxcox, 
                                             newdata = traffic_train_test$traffic)
```

We can compare the results of transformation below. Although the new distribution is not ideally symmetrical, the predictive power of our model should still improve. 

```{r message=FALSE, warning=FALSE, fig.height=3}
g1 <- ggplot(traffic_train_train,aes(x = traffic)) + geom_histogram(fill="grey",bins=100) + theme_classic()
g2 <- ggplot(traffic_train_train,aes(x = traffic_boxcox)) + geom_histogram(fill="grey",bins=100) + theme_classic()
grid.arrange(g1,g2,ncol=2)
```

#### Features binning

We used the cut() function to divide the following variables into bigger groups: clouds_coverage_pct, months and time.

As for the clouds_coverage_pct, we divided the observations into groups based on their quantiles. The final intervals were as following: [0,1], (1,40], (40,75], (75,90], (90,100].

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train_train$clouds_pct_qntls <- 
  cut(traffic_train_train$clouds_coverage_pct, 
      breaks = quantile(traffic_train_train$clouds_coverage_pct, 
                        probs = seq(0, 1, 0.2)),
      include.lowest = TRUE)

traffic_train_test$clouds_pct_qntls <- 
  cut(traffic_train_test$clouds_coverage_pct, 
      breaks= c(0,1,40,75,90,100), 
      include.lowest = TRUE,
      ordered_result = TRUE)

traffic_test$clouds_pct_qntls <- 
  cut(traffic_test$clouds_coverage_pct, 
      breaks= c(0,1,40,75,90,100), 
      include.lowest = TRUE,
      ordered_result = TRUE)
```


```{r message=FALSE, warning=FALSE, echo=FALSE, fig.height=3}
g1 <- ggplot(traffic_train_train,aes(x = clouds_coverage_pct, y = traffic)) + geom_point(fill = "gray") + theme_classic()
g2 <- ggplot(traffic_train_train,aes(x = clouds_pct_qntls, y = traffic)) + geom_boxplot(fill = "gray") + theme_classic()
grid.arrange(g1,g2,ncol=2)

```


The feature Month was divided into the 4 natural seasons: spring, summer, fall and winter. We also checked if the months had similar traffic mean for each season.

```{r message=FALSE, warning=FALSE, echo=FALSE, results="hide"}
traffic_train_train %>% 
  group_by(month) %>% 
  summarise(AvgTraffic_bc=mean(traffic, na.rm=T),
            Count=n()) %>% 
  arrange(desc(AvgTraffic_bc))
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train_train$season <- as.numeric(as.character(traffic_train_train$month))
traffic_train_train$season <- 
  cut(traffic_train_train$season,
      breaks= c(1,2,5,8,11,12),
      include.lowest = TRUE,
      right = TRUE,
      labels=c("winter","spring","summer","fall","winter"),
      ordered_result = FALSE)

traffic_train_test$season <- as.numeric(as.character(traffic_train_test$month))
traffic_train_test$season <- 
  cut(traffic_train_test$season,
      breaks= c(1,2,5,8,11,12),
      include.lowest = TRUE,
      right = TRUE,
      labels=c("winter","spring","summer","fall","winter"),
      ordered_result = FALSE)

traffic_test$season <- as.numeric(as.character(traffic_test$month))
traffic_test$season <- 
  cut(traffic_test$season,
      breaks= c(1,2,5,8,11,12),
      include.lowest = TRUE,
      right = TRUE,
      labels=c("winter","spring","summer","fall","winter"),
      ordered_result = FALSE)
```


```{r message=FALSE, warning=FALSE, echo=FALSE, fig.height=3}
g1 <- ggplot(traffic_train_train,aes(x = month, y = traffic)) + geom_boxplot(fill = "gray") + theme_classic()
g2 <- ggplot(traffic_train_train,aes(x = season, y = traffic)) + geom_boxplot(fill = "gray") + theme_classic()
grid.arrange(g1,g2,ncol=2)

```



The binning of the time feature was based on the graph and mean traffic values analysis.
We decided to create five levels: "morning","midday","afternoon","evening" and "night", corresponding with the following hours: 6-10,11-14,15-17,18-21,22-5.

```{r message=FALSE, warning=FALSE, echo=FALSE, results="hide"}
traffic_train_train %>% 
  group_by(time) %>% 
  summarise(AvgTraffic_bc=mean(traffic, na.rm=T),
            Count=n()) %>% 
  arrange(desc(AvgTraffic_bc)) %>% print(n = Inf)
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_train_train$time2 <- as.numeric(as.character(traffic_train_train$time))
traffic_train_train$time2 <- 
  cut(traffic_train_train$time2,
      breaks= c(0,6,11,15,18,22,24),
      include.lowest = TRUE,
      right = FALSE,
      labels=c("night","morning","midday","afternoon","evening","night"),
      ordered_result = FALSE)

traffic_train_test$time2 <- as.numeric(as.character(traffic_train_test$time))
traffic_train_test$time2 <- 
  cut(traffic_train_test$time2,
      breaks= c(0,6,11,15,18,22,24),
      include.lowest = TRUE,
      right = FALSE,
      labels=c("night","morning","midday","afternoon","evening","night"),
      ordered_result = FALSE)

traffic_test$time2 <-  as.numeric(as.character(traffic_test$time))
traffic_test$time2 <- 
  cut(traffic_test$time2, 
      breaks= c(0,6,11,15,18,22,24), 
      include.lowest = TRUE,
      labels=c("night","morning","midday","afternoon","evening","night"),
      ordered_result = FALSE)
```


```{r message=FALSE, warning=FALSE, echo=FALSE, fig.height=3}
g1 <- ggplot(traffic_train_train,aes(x = time, y = traffic)) + geom_boxplot(fill = "gray") + theme_classic()
g2 <- ggplot(traffic_train_train,aes(x = time2, y = traffic)) + geom_boxplot(fill = "gray") + theme_classic()
grid.arrange(g1,g2,ncol=2)

```

## Final model

The best results were estimated using a model with grouped features and a feature describing yearweeks (which probably represented the effect on holidays on traffic).

```{r message=FALSE, warning=FALSE}
selected3 <- c("weather_general2","clouds_pct_qntls", "temperature", "rain_mm",
               "time2", "season", "year", "weekend","traffic", "traffic_boxcox", "yearweek")
```


```{r message=FALSE, warning=FALSE, results="hide", echo=FALSE}

traffic_var3_train <- traffic_train_train[,which(colnames(traffic_train_train) %in% selected3)]
traffic_var3_test <- traffic_train_test[,which(colnames(traffic_train_test) %in% selected3)]


traffic_forecast_train <- data.frame(traffic=traffic_train_train$traffic)
traffic_forecast_test <- data.frame(traffic=traffic_train_test$traffic)
```

#### Time series cross-validation

Because traffic data set contains a time series data, we decided to use a time-based split for cross-validation. Using a "timeslice" method the test sample was divided into 5 slices, each containing 8 000 observations.

```{r message=FALSE, warning=FALSE, results="hide"}
options(contrasts = c("contr.treatment",  # for non-ordinal factors
                      "contr.treatment")) # for ordinal factors

myTimeControl <- trainControl(method = "timeslice",
                              initialWindow = 6000,
                              horizon = 2000,
                              fixedWindow = TRUE,
                              skip=3000)
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
regressionMetrics <- function(real, predicted) {
  # Mean Square Error
  MSE <- mean((real - predicted)^2)
  # Root Mean Square Error
  RMSE <- sqrt(MSE)
  # Mean Absolute Error
  MAE <- mean(abs(real - predicted))
  # Mean Absolute Percentage Error
  MAPE <- mean(abs(real - predicted)/real)
  # R2
  R2 <- cor(predicted, real)^2
  
  result <- data.frame(MSE, RMSE, MAE, MAPE, R2)
  return(result)
}
```

#### KNN

During the process of model selection we run the linear models using different features, the KNN models with the k-parametr optimalization, and the LASSO and elastic Net model. The interpretation of the results was not straightforward. For MAPE, the KNN model turned out to be the most optimal. On the other hand, it achieved a small R2 as well as high absolute errors. If we took a different measure as selection criteria, then probably the linear model would be the optimal one.

For our KNN model, first We tried a very wide range of k values - from 1 to 150 (corresponding with a size of our data). In the second step we narrowed it and at the end we decided to keep the KNN model with k=8.

```{r message=FALSE, warning=FALSE}
different_k3b <- data.frame(k = seq(1,20, 1))

traffic_knn3b <- 
  train(traffic_boxcox ~ ., 
        data = traffic_var3_train %>% 
          # we exclude traffic
          dplyr::select(-traffic)
        ,
        # model type - now knn!!
        method = "knn",
        # validation used!
        trControl = myTimeControl,
        # parameters to be compared
        tuneGrid = different_k3b,
        metric = "RMSE",
        preProcess = c("range"))

traffic_knn3b

plot(traffic_knn3b)
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
traffic_forecast_train$traffic_forecast_knn3b <-(sapply(predict(traffic_knn3b,traffic_var3_train), function(x){max(0,x)})*traffic_boxcox$lambda+
                                               1)^(1/traffic_boxcox$lambda)

traffic_forecast_test$traffic_forecast_knn3b <-(sapply(predict(traffic_knn3b,traffic_var3_test), function(x){max(0,x)})*traffic_boxcox$lambda+
                                              1)^(1/traffic_boxcox$lambda)

knn_train_results <- regressionMetrics(real = traffic_forecast_train$traffic+1,
                  predicted = traffic_forecast_train$traffic_forecast_knn3b)
knn_test_results <- regressionMetrics(real = traffic_forecast_test$traffic+1,
                  predicted = traffic_forecast_test$traffic_forecast_knn3b)

```


```{r message=FALSE, warning=FALSE, echo=FALSE}
comparison_traffic <- do.call(rbind, list(knn_train_results,knn_test_results))
rownames(comparison_traffic) <- c("knn_train", "knn_test") 
comparison_traffic
```

```{r message=FALSE, warning=FALSE}
final_k <- data.frame(k = 8)

traffic_bestModel <- 
  train(traffic_boxcox ~ ., 
        data = traffic_var3_train %>% 
          # we exclude traffic
          dplyr::select(-traffic)
        ,
        # model type - now knn!!
        method = "knn",
        # validation used!
        trControl = myTimeControl,
        # parameters to be compared
        tuneGrid = final_k,
        metric = "RMSE",
        preProcess = c("range"))

traffic_bestModel

```

The comparison between the predicted and real traffic values, for both the train and the test sample, is presented below: 

```{r message=FALSE, warning=FALSE, echo=FALSE, fig.height=4}
g1 <- ggplot(traffic_forecast_train,
       aes(x = traffic_forecast_knn3b,
           y = traffic)) +
  geom_point(col = "grey") +
  geom_smooth(method = "lm", se = FALSE)  + theme_classic()
g2 <- ggplot(traffic_forecast_test,
       aes(x = traffic_forecast_knn3b,
           y = traffic)) +
  geom_point(col = "grey") +
  geom_smooth(method = "lm", se = FALSE)  + theme_classic()
grid.arrange(g1,g2,ncol=2)

```

It is worth mentioning that the error measured on the test sample was much higher than on the the training data. Therefore we don't expect the results to be very accurate, the MAPE will probably be close to 5.

Prediction:

```{r message=FALSE, warning=FALSE}
traffic_test$traffic_forecast <-(sapply(predict(traffic_knn3b,traffic_test), function(x){max(0,x)})*traffic_boxcox$lambda+1)^(1/traffic_boxcox$lambda)
```

```{r message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
write.csv2(traffic_test$traffic_forecast, file = "traffic_forecast.csv",  row.names = FALSE)
```
